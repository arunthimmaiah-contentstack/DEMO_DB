# Reference this view as omni_dbt_marts__mel_to_mql_conversion
schema_label: ""

schema: omni_dbt_marts
table_name: MEL_TO_MQL_CONVERSION

dimensions:
  metric_name:
    sql: '"METRIC_NAME"'

  object:
    sql: '"OBJECT"'

  id:
    sql: '"ID"'
    format: ID
    primary_key: true

  product:
    sql: '"PRODUCT"'

  customer_designation:
    sql: '"CUSTOMER_DESIGNATION"'

  product_deal_percentage:
    sql: '"PRODUCT_DEAL_PERCENTAGE"'

  metric_date_1:
    sql: '"METRIC_DATE_1"'

  metric_date_2:
    sql: '"METRIC_DATE_2"'

  metric_measure_1:
    sql: '"METRIC_MEASURE_1"'

  metric_measure_2:
    sql: '"METRIC_MEASURE_2"'

  metric_measure_3:
    sql: '"METRIC_MEASURE_3"'

  geo_c:
    sql: '"GEO_C"'

  region:
    sql: '"REGION"'

  sub_region:
    sql: '"SUB_REGION"'

  revenue:
    sql: '"REVENUE"'

  company_size:
    sql: '"COMPANY_SIZE"'

  record_type:
    sql: '"RECORD_TYPE"'

  leadsource:
    sql: '"LEADSOURCE"'

  motion:
    sql: '"MOTION"'

  sub_motion:
    sql: '"SUB_MOTION"'

  opp_type:
    sql: '"OPP_TYPE"'

  account_name:
    sql: '"ACCOUNT_NAME"'

  matched_account_tier_ld:
    sql: '"MATCHED_ACCOUNT_TIER_LD"'

  account_tier:
    sql: '"ACCOUNT_TIER"'

  deployment_status_c:
    sql: '"DEPLOYMENT_STATUS_C"'

  type:
    sql: '"TYPE"'

  sync_date:
    sql: '"SYNC_DATE"'

  sales_motion:
    sql: '"SALES_MOTION"'

  expansion_sales_motion:
    sql: '"EXPANSION_SALES_MOTION"'

  demand_bucket:
    sql: '"DEMAND_BUCKET"'

measures:
  count:
    aggregate_type: count

#The info below was pulled from your dbt repository and is read-only.
dbt:
  name: mel_to_mql_conversion
  target_schema: STAGING
  config:
    schema: marts
    materialized: table
  code: |-
    SELECT
      'MEL TO MQL Conversion %' AS metric_name,
      'Lead' AS object,
      NULL AS ID,
      NULL AS PRODUCT,
      NULL AS CUSTOMER_DESIGNATION,
      NULL AS PRODUCT_DEAL_PERCENTAGE,
      DATE_TRUNC('MONTH',CONVERT_TIMEZONE('UTC', 'America/Los_Angeles', STAGE_DATE_MEL_C::timestamp_ntz)) AS metric_date_1,
      NULL AS metric_date_2,
      NULL AS metric_measure_1,
      ROUND((COUNT(DISTINCT CASE WHEN STAGE_DATE_MQL_V_2_C IS NOT NULL THEN LEAD_INFO.ID END) * 1/(COUNT(DISTINCT(LEAD_INFO.ID)))),2) AS metric_measure_2,
      NULL AS METRIC_MEASURE_3,
      NULL as GEO_C,
      NULL AS region,
      NULL as SUB_REGION,
      NULL AS REVENUE,
      NULL AS COMPANY_SIZE,
      NULL AS RECORD_TYPE,
      NULL AS LeadSource,
      NULL AS MOTION,
      NULL AS SUB_MOTION,
      NULL AS opp_type,
      NULL AS ACCOUNT_NAME,
      NULL AS Matched_Account_Tier_LD,
      NULL AS Account_Tier,
      NULL AS DEPLOYMENT_STATUS_C,
      NULL AS TYPE
      ,CONVERT_TIMEZONE('UTC', 'America/Los_Angeles', LEAD_INFO._FIVETRAN_SYNCED::timestamp_ntz) AS SYNC_DATE,
      NULL AS SALES_MOTION, --THIS IS A NEW FIELD ADDED IN ASC (OBI-1404 & 1405)
      NULL AS EXPANSION_SALES_MOTION, --THIS IS A NEW FIELD ADDED IN ASC (OBI-1404 & 1405)
      NULL AS DEMAND_BUCKET
    FROM {{ref('stg_salesforce__leads_info')}} AS LEAD_INFO
    LEFT JOIN {{ref('stg_salesforce__leads_stages')}} AS LEAD_STAGES
        ON LEAD_INFO.ID = LEAD_STAGES.ID
    LEFT JOIN {{ref('stg_salesforce__leads_contact')}} AS LEAD_CONTACTS
        ON LEAD_INFO.ID = LEAD_CONTACTS.ID
    WHERE 
        1=1
        AND (STAGE_DATE_MQL_V_2_C IS NULL OR CONVERT_TIMEZONE('UTC', 'America/Los_Angeles', STAGE_DATE_MQL_V_2_C::timestamp_ntz) >= CONVERT_TIMEZONE('UTC', 'America/Los_Angeles', STAGE_DATE_MEL_C::timestamp_ntz))
        AND CONVERT_TIMEZONE('UTC', 'America/Los_Angeles', STAGE_DATE_MEL_C::timestamp_ntz) > '2023-02-01'
        AND STATUS NOT IN ('Customer', 'Partner')
        AND IS_DELETED != 'TRUE'
        AND EMAIL NOT LIKE '%contentstack%'
    GROUP BY metric_date_1,SYNC_DATE
