# Reference this view as omni_dbt__fct_test_directories
schema_label: ""
#This description was pulled from dbt.
description: This finds all cases where the yml file for model tests is NOT in
  the same subdirectory as the corresponding model.

schema: omni_dbt
table_name: FCT_TEST_DIRECTORIES

dimensions:
  test_name:
    sql: '"TEST_NAME"'

  model_name:
    sql: '"MODEL_NAME"'

  current_test_directory:
    sql: '"CURRENT_TEST_DIRECTORY"'

  change_test_directory_to:
    sql: '"CHANGE_TEST_DIRECTORY_TO"'

measures:
  count:
    aggregate_type: count

#The info below was pulled from your dbt repository and is read-only.
dbt:
  name: fct_test_directories
  target_schema: STAGING
  description: This finds all cases where the yml file for model tests is NOT in
    the same subdirectory as the corresponding model.
  config:
    materialized: view
  code: |-
    with

    resources as (

        select * from {{ ref('int_all_graph_resources') }}
        where not is_excluded

    ),

    relationships as (

        select * from {{ ref('int_direct_relationships') }}

    ),

    models_per_test as (

        select
            resource_name as test_name,
            resource_id as test_id,
            direct_parent_id as parent_model_id
        from relationships
        where resource_type = 'test'
        and is_primary_test_relationship

    ),

    model_file_paths as (

        select
            resources.resource_id as model_id,
            resources.resource_name as model_name,
            resources.directory_path as model_directory_path,
            models_per_test.test_id,
            models_per_test.parent_model_id
        from resources
        inner join models_per_test
        on models_per_test.parent_model_id = resources.resource_id
        where resource_type = 'model'

    ),

    test_file_paths as (

        select
            resource_id as test_id,
            resource_name as test_name,
            file_name as test_yml_name,
            directory_path as test_yml_directory_path
        from resources
        where 
            resource_type = 'test'
            and is_generic_test

    ),

    all_file_paths as (

        select
            test_file_paths.test_id,
            test_file_paths.test_name,
            test_file_paths.test_yml_directory_path,
            test_file_paths.test_yml_name,
            model_file_paths.model_id,
            model_file_paths.model_name,
            model_file_paths.model_directory_path
        from model_file_paths
        inner join test_file_paths
        on model_file_paths.test_id = test_file_paths.test_id

    ),

    different_directories as (

        select
            test_name,
            model_name,
            test_yml_directory_path as current_test_directory,
            model_directory_path as change_test_directory_to
        from all_file_paths
        where model_directory_path != test_yml_directory_path

    )

    select * from different_directories

    {{ filter_exceptions() }}
