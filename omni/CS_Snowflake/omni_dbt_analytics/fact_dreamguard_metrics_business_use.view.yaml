# Reference this view as omni_dbt_analytics__fact_dreamguard_metrics_business_use
schema_label: ""
#This description was pulled from dbt.
description: Fact table combining Salesforce opportunity, account, and currency
  rate data with calculated metrics for Dreamguard analytics.

schema: omni_dbt_analytics
table_name: FACT_DREAMGUARD_METRICS_BUSINESS_USE

dimensions:
  metric_name:
    sql: '"METRIC_NAME"'

  object:
    sql: '"OBJECT"'

  id:
    sql: '"ID"'
    format: ID
    #This description was pulled from dbt.
    description: Opportunity ID from Salesforce. Not unique in this fact table but
      required for identifying related records.
    primary_key: true

  product:
    sql: '"PRODUCT"'

  customer_designation:
    sql: '"CUSTOMER_DESIGNATION"'

  product_deal_percentage:
    sql: '"PRODUCT_DEAL_PERCENTAGE"'

  stage_date_mel_c:
    sql: '"STAGE_DATE_MEL_C"'

  stage_date_mql_v_2_c:
    sql: '"STAGE_DATE_MQL_V_2_C"'

  stage_date_sal_v_2_c:
    sql: '"STAGE_DATE_SAL_V_2_C"'

  stage_date_sql_v_2_c:
    sql: '"STAGE_DATE_SQL_V_2_C"'

  pipeline_date_c:
    sql: '"PIPELINE_DATE_C"'

  close_date:
    sql: '"CLOSE_DATE"'
    #This description was pulled from dbt.
    description: Date when the opportunity was closed.

  stage_enter_mqo_c:
    sql: '"STAGE_ENTER_MQO_C"'

  license_start_date_c:
    sql: '"LICENSE_START_DATE_C"'

  predicted_go_live_date_c:
    sql: '"PREDICTED_GO_LIVE_DATE_C"'

  actual_go_live_date_c:
    sql: '"ACTUAL_GO_LIVE_DATE_C"'

  conversion_month:
    sql: '"CONVERSION_MONTH"'

  lost_reason_c:
    sql: '"LOST_REASON_C"'

  onboarded_on_time_flag:
    sql: '"ONBOARDED_ON_TIME_FLAG"'

  conversion_rate_pct:
    sql: '"CONVERSION_RATE_PCT"'

  total_original_piped_amount:
    sql: '"TOTAL_ORIGINAL_PIPED_AMOUNT"'

  product_piped_amount:
    sql: '"PRODUCT_PIPED_AMOUNT"'

  opp_total_bookings:
    sql: '"OPP_TOTAL_BOOKINGS"'

  product_bookings:
    sql: '"PRODUCT_BOOKINGS"'

  opp_expansion_bookings:
    sql: '"OPP_EXPANSION_BOOKINGS"'

  sales_cycle_days:
    sql: '"SALES_CYCLE_DAYS"'
    #This description was pulled from dbt.
    description: Number of days between pipeline entry and deal closure.

  deployment_days:
    sql: '"DEPLOYMENT_DAYS"'

  geo_c:
    sql: '"GEO_C"'

  owner_region_c:
    sql: '"OWNER_REGION_C"'

  owner_sub_region_c:
    sql: '"OWNER_SUB_REGION_C"'

  annual_revenue_c:
    sql: '"ANNUAL_REVENUE_C"'

  company_size:
    sql: '"COMPANY_SIZE"'

  record_type_c:
    sql: '"RECORD_TYPE_C"'
    #This description was pulled from dbt.
    description: Type of the opportunity record, e.g., Sales, Upsell, Cross-Sell, or
      Renewal.

  lead_source:
    sql: '"LEAD_SOURCE"'

  motion:
    sql: '"MOTION"'
    #This description was pulled from dbt.
    description: Categorization of the sales motion (e.g., GTM, Partner, etc).

  lead_source_category_c:
    sql: '"LEAD_SOURCE_CATEGORY_C"'

  opp_type:
    sql: '"OPP_TYPE"'

  account_name:
    sql: '"ACCOUNT_NAME"'

  matched_account_name_c:
    sql: '"MATCHED_ACCOUNT_NAME_C"'

  account_tier_c:
    sql: '"ACCOUNT_TIER_C"'

  deployment_status_c:
    sql: '"DEPLOYMENT_STATUS_C"'

  type:
    sql: '"TYPE"'

  sync_date:
    sql: '"SYNC_DATE"'

  cms_sales_motion_c:
    sql: '"CMS_SALES_MOTION_C"'

  expansion_sales_motion_c:
    sql: '"EXPANSION_SALES_MOTION_C"'

  demand_bucket_c:
    sql: '"DEMAND_BUCKET_C"'

  fiscal_quarter:
    sql: '"FISCAL_QUARTER"'

  fiscal_year:
    sql: '"FISCAL_YEAR"'

measures:
  count:
    aggregate_type: count

#The info below was pulled from your dbt repository and is read-only.
dbt:
  name: fact_dreamguard_metrics_business_use
  target_schema: STAGING
  description: Fact table combining Salesforce opportunity, account, and currency
    rate data with calculated metrics for Dreamguard analytics.
  config:
    schema: analytics
    materialized: table
  code: |-
    {{ config(
        materialized='table',
        schema='analytics'
    ) }}

    with lead_base as (
        select
            id,
            company,
            lead_source,
            lead_source_category_c,
            email,
            status,
            geo_c,
            annual_revenue_c,
            customer_segment_c,
            matched_account_name_c,
            matched_account_tier_ld_c,
            stage_date_mel_c,
            stage_date_mql_v_2_c,
            stage_date_sal_v_2_c,
            stage_date_sql_v_2_c,
            contact_us_subject_c,
            _fivetran_synced
        from {{ ref('stg_lead_dg') }}
    ),

    account_base as (
        select
            id,
            name,
            customer_segment_c,
            account_tier_c,
            geo_c,
            region_c,
            sub_region_c,
            revenue_c,
            type,
            deployment_status_c,
            license_start_date_c,
            actual_go_live_date_c,
            predicted_go_live_date_c,
            _fivetran_synced
        from {{ ref('stg_account_dg') }}
    ),

    opportunity_base as (
        select
            id,
            account_id,
            record_type_c,
            type,
            lead_source,
            lead_source_category_c,
            owner_region_c,
            owner_sub_region_c,
            currency_iso_code,
            total_original_piped_amount_c,
            cdp_pipeline_percentage_c,
            cdp_deal_percentage_c,
            pipeline_date_c,
            close_date,
            stage_name,
            opp_total_bookings_c,
            opp_expansion_bookings_c,
            lost_reason_c,
            is_won,
            stage_enter_mqo_c,
            demand_bucket_c,
            cms_sales_motion_c,
            expansion_sales_motion_c,
            _fivetran_synced
        from {{ ref('stg_salesforce__opportunity_dg') }}
    ),

    conversion_rate as (
        select
            iso_code,
            conversion_rate,
            start_date,
            next_start_date
        from {{ ref('stg_dated_conversion_rate') }}
    ),

    -- MEL Volume
    mel_volume as (
        select
            'MEL Volume' as metric_name,
            'Lead' as object,
            id,
            null as product,
            null as customer_designation,
            null as product_deal_percentage,
            convert_timezone('UTC', 'America/Los_Angeles', stage_date_mel_c::timestamp_ntz) as stage_date_mel_c,
            null as stage_date_mql_v_2_c,
            null as stage_date_sal_v_2_c,
            null as stage_date_sql_v_2_c,
            null as pipeline_date_c,
            null as close_date,
            null as stage_enter_mqo_c,
            null as license_start_date_c,
            null as predicted_go_live_date_c,
            null as actual_go_live_date_c,
            null as conversion_month,
            null as lost_reason_c,
            null as onboarded_on_time_flag,
            null as conversion_rate_pct,
            null as total_original_piped_amount,
            null as product_piped_amount,
            null as opp_total_bookings,
            null as product_bookings,
            null as opp_expansion_bookings,
            null as sales_cycle_days,
            null as deployment_days,
            geo_c,
            null as owner_region_c,
            null as owner_sub_region_c,
            annual_revenue_c,
            case
                when customer_segment_c = 'Enterprise Customer' then 'Revenue > $1B'
                when customer_segment_c = 'MM Customer' then 'Revenue < $1B'
                else customer_segment_c
            end as company_size,
            null as record_type_c,
            lead_source,
            case 
                when lead_source_category_c in ('Sales', 'Marketing') then 'GTM'
                when lead_source_category_c in ('Partner') then 'Partner'
                when lead_source_category_c in ('Customer') then 'Expansion'
                else null
            end as motion,
            lead_source_category_c,
            null as opp_type,
            company as account_name,
            matched_account_name_c,
            matched_account_tier_ld_c as account_tier_c,
            null as deployment_status_c,
            null as type,
            convert_timezone('UTC', 'America/Los_Angeles', _fivetran_synced::timestamp_ntz) as sync_date,
            null as cms_sales_motion_c,
            null as expansion_sales_motion_c,
            null as demand_bucket_c,
            case
                when month(stage_date_mel_c) in (2, 3, 4) then 1
                when month(stage_date_mel_c) in (5, 6, 7) then 2
                when month(stage_date_mel_c) in (8, 9, 10) then 3
                when month(stage_date_mel_c) in (11, 12, 1) then 4
            end as fiscal_quarter,
            case
                when month(stage_date_mel_c) >= 2 then year(stage_date_mel_c) + 1
                else year(stage_date_mel_c)
            end as fiscal_year
        from lead_base
        where 1=1
            and (lead_source not like 'In Product Contentstack' or lead_source is null)
            and (email not like '%contentstack%' or email is null)
            and (contact_us_subject_c not in ('Free Trial') or contact_us_subject_c is null)
            and (status not in ('Customer','Partner') or status is null)
    ),

    -- MQL Volume
    mql_volume as (
        select
            'MQL Volume' as metric_name,
            'Lead' as object,
            id,
            null as product,
            null as customer_designation,
            null as product_deal_percentage,
            null as stage_date_mel_c,
            convert_timezone('UTC', 'America/Los_Angeles', stage_date_mql_v_2_c::timestamp_ntz) as stage_date_mql_v_2_c,
            null as stage_date_sal_v_2_c,
            null as stage_date_sql_v_2_c,
            null as pipeline_date_c,
            null as close_date,
            null as stage_enter_mqo_c,
            null as license_start_date_c,
            null as predicted_go_live_date_c,
            null as actual_go_live_date_c,
            null as conversion_month,
            null as lost_reason_c,
            null as onboarded_on_time_flag,
            null as conversion_rate_pct,
            null as total_original_piped_amount,
            null as product_piped_amount,
            null as opp_total_bookings,
            null as product_bookings,
            null as opp_expansion_bookings,
            null as sales_cycle_days,
            null as deployment_days,
            geo_c,
            null as owner_region_c,
            null as owner_sub_region_c,
            annual_revenue_c,
            case
                when customer_segment_c = 'Enterprise Customer' then 'Revenue > $1B'
                when customer_segment_c = 'MM Customer' then 'Revenue < $1B'
                else customer_segment_c
            end as company_size,
            null as record_type_c,
            lead_source,
            case 
                when lead_source_category_c in ('Sales', 'Marketing') then 'GTM'
                when lead_source_category_c in ('Partner') then 'Partner'
                when lead_source_category_c in ('Customer') then 'Expansion'
                else null
            end as motion,
            lead_source_category_c,
            null as opp_type,
            company as account_name,
            matched_account_name_c,
            matched_account_tier_ld_c as account_tier_c,
            null as deployment_status_c,
            null as type,
            convert_timezone('UTC', 'America/Los_Angeles', _fivetran_synced::timestamp_ntz) as sync_date,
            null as cms_sales_motion_c,
            null as expansion_sales_motion_c,
            null as demand_bucket_c,
            case
                when month(stage_date_mql_v_2_c) in (2, 3, 4) then 1
                when month(stage_date_mql_v_2_c) in (5, 6, 7) then 2
                when month(stage_date_mql_v_2_c) in (8, 9, 10) then 3
                when month(stage_date_mql_v_2_c) in (11, 12, 1) then 4
            end as fiscal_quarter,
            case
                when month(stage_date_mql_v_2_c) >= 2 then year(stage_date_mql_v_2_c) + 1
                else year(stage_date_mql_v_2_c)
            end as fiscal_year
        from lead_base
        where 1=1
            and (lead_source not like 'In Product Contentstack' or lead_source is null)
            and (email not like '%contentstack%' or email is null)
            and (contact_us_subject_c not in ('Free Trial') or contact_us_subject_c is null)
            and (status not in ('Customer','Partner') or status is null)
    ),

    -- SAL Volume
    sal_volume as (
        select
            'SAL Volume' as metric_name,
            'Lead' as object,
            id,
            null as product,
            null as customer_designation,
            null as product_deal_percentage,
            null as stage_date_mel_c,
            null as stage_date_mql_v_2_c,
            convert_timezone('UTC', 'America/Los_Angeles', stage_date_sal_v_2_c::timestamp_ntz) as stage_date_sal_v_2_c,
            null as stage_date_sql_v_2_c,
            null as pipeline_date_c,
            null as close_date,
            null as stage_enter_mqo_c,
            null as license_start_date_c,
            null as predicted_go_live_date_c,
            null as actual_go_live_date_c,
            null as conversion_month,
            null as lost_reason_c,
            null as onboarded_on_time_flag,
            null as conversion_rate_pct,
            null as total_original_piped_amount,
            null as product_piped_amount,
            null as opp_total_bookings,
            null as product_bookings,
            null as opp_expansion_bookings,
            null as sales_cycle_days,
            null as deployment_days,
            geo_c,
            null as owner_region_c,
            null as owner_sub_region_c,
            annual_revenue_c,
            case
                when customer_segment_c = 'Enterprise Customer' then 'Revenue > $1B'
                when customer_segment_c = 'MM Customer' then 'Revenue < $1B'
                else customer_segment_c
            end as company_size,
            null as record_type_c,
            lead_source,
            case 
                when lead_source_category_c in ('Sales', 'Marketing') then 'GTM'
                when lead_source_category_c in ('Partner') then 'Partner'
                when lead_source_category_c in ('Customer') then 'Expansion'
                else null
            end as motion,
            lead_source_category_c,
            null as opp_type,
            company as account_name,
            matched_account_name_c,
            matched_account_tier_ld_c as account_tier_c,
            null as deployment_status_c,
            null as type,
            convert_timezone('UTC', 'America/Los_Angeles', _fivetran_synced::timestamp_ntz) as sync_date,
            null as cms_sales_motion_c,
            null as expansion_sales_motion_c,
            null as demand_bucket_c,
            case
                when month(stage_date_sal_v_2_c) in (2, 3, 4) then 1
                when month(stage_date_sal_v_2_c) in (5, 6, 7) then 2
                when month(stage_date_sal_v_2_c) in (8, 9, 10) then 3
                when month(stage_date_sal_v_2_c) in (11, 12, 1) then 4
            end as fiscal_quarter,
            case
                when month(stage_date_sal_v_2_c) >= 2 then year(stage_date_sal_v_2_c) + 1
                else year(stage_date_sal_v_2_c)
            end as fiscal_year
        from lead_base
        where 1=1
            and (lead_source not like 'In Product Contentstack' or lead_source is null)
            and (email not like '%contentstack%' or email is null)
            and (contact_us_subject_c not in ('Free Trial') or contact_us_subject_c is null)
            and (status not in ('Customer','Partner') or status is null)
    ),

    -- SQL Volume
    sql_volume as (
        select
            'SQL Volume' as metric_name,
            'Lead' as object,
            id,
            null as product,
            null as customer_designation,
            null as product_deal_percentage,
            null as stage_date_mel_c,
            null as stage_date_mql_v_2_c,
            null as stage_date_sal_v_2_c,
            convert_timezone('UTC', 'America/Los_Angeles', stage_date_sql_v_2_c::timestamp_ntz) as stage_date_sql_v_2_c,
            null as pipeline_date_c,
            null as close_date,
            null as stage_enter_mqo_c,
            null as license_start_date_c,
            null as predicted_go_live_date_c,
            null as actual_go_live_date_c,
            null as conversion_month,
            null as lost_reason_c,
            null as onboarded_on_time_flag,
            null as conversion_rate_pct,
            null as total_original_piped_amount,
            null as product_piped_amount,
            null as opp_total_bookings,
            null as product_bookings,
            null as opp_expansion_bookings,
            null as sales_cycle_days,
            null as deployment_days,
            geo_c,
            null as owner_region_c,
            null as owner_sub_region_c,
            annual_revenue_c,
            case
                when customer_segment_c = 'Enterprise Customer' then 'Revenue > $1B'
                when customer_segment_c = 'MM Customer' then 'Revenue < $1B'
                else customer_segment_c
            end as company_size,
            null as record_type_c,
            lead_source,
            case 
                when lead_source_category_c in ('Sales', 'Marketing') then 'GTM'
                when lead_source_category_c in ('Partner') then 'Partner'
                when lead_source_category_c in ('Customer') then 'Expansion'
                else null
            end as motion,
            lead_source_category_c,
            null as opp_type,
            company as account_name,
            matched_account_name_c,
            matched_account_tier_ld_c as account_tier_c,
            null as deployment_status_c,
            null as type,
            convert_timezone('UTC', 'America/Los_Angeles', _fivetran_synced::timestamp_ntz) as sync_date,
            null as cms_sales_motion_c,
            null as expansion_sales_motion_c,
            null as demand_bucket_c,
            case
                when month(stage_date_sql_v_2_c) in (2, 3, 4) then 1
                when month(stage_date_sql_v_2_c) in (5, 6, 7) then 2
                when month(stage_date_sql_v_2_c) in (8, 9, 10) then 3
                when month(stage_date_sql_v_2_c) in (11, 12, 1) then 4
            end as fiscal_quarter,
            case
                when month(stage_date_sql_v_2_c) >= 2 then year(stage_date_sql_v_2_c) + 1
                else year(stage_date_sql_v_2_c)
            end as fiscal_year
        from lead_base
        where 1=1
            and (lead_source not like 'In Product Contentstack' or lead_source is null)
            and (email not like '%contentstack%' or email is null)
            and (contact_us_subject_c not in ('Free Trial') or contact_us_subject_c is null)
            and (status not in ('Customer','Partner') or status is null)
    ),

    -- MEL to MQL Conversion %
    mel_to_mql_conversion as (
        select
            'MEL TO MQL Conversion %' as metric_name,
            'Lead' as object,
            null as id,
            null as product,
            null as customer_designation,
            null as product_deal_percentage,
            null as stage_date_mel_c,
            null as stage_date_mql_v_2_c,
            null as stage_date_sal_v_2_c,
            null as stage_date_sql_v_2_c,
            null as pipeline_date_c,
            null as close_date,
            null as stage_enter_mqo_c,
            null as license_start_date_c,
            null as predicted_go_live_date_c,
            null as actual_go_live_date_c,
            date_trunc('MONTH', convert_timezone('UTC', 'America/Los_Angeles', stage_date_mel_c::timestamp_ntz)) as conversion_month,
            null as lost_reason_c,
            null as onboarded_on_time_flag,
            round((count(distinct case when stage_date_mql_v_2_c is not null then id end) * 1.0 / count(distinct id)), 2) as conversion_rate_pct,
            null as total_original_piped_amount,
            null as product_piped_amount,
            null as opp_total_bookings,
            null as product_bookings,
            null as opp_expansion_bookings,
            null as sales_cycle_days,
            null as deployment_days,
            null as geo_c,
            null as owner_region_c,
            null as owner_sub_region_c,
            null as annual_revenue_c,
            null as company_size,
            null as record_type_c,
            null as lead_source,
            null as motion,
            null as lead_source_category_c,
            null as opp_type,
            null as account_name,
            null as matched_account_name_c,
            null as account_tier_c,
            null as deployment_status_c,
            null as type,
            convert_timezone('UTC', 'America/Los_Angeles', _fivetran_synced::timestamp_ntz) as sync_date,
            null as cms_sales_motion_c,
            null as expansion_sales_motion_c,
            null as demand_bucket_c,
            case
                when month(conversion_month) in (2, 3, 4) then 1
                when month(conversion_month) in (5, 6, 7) then 2
                when month(conversion_month) in (8, 9, 10) then 3
                when month(conversion_month) in (11, 12, 1) then 4
            end as fiscal_quarter,
            case
                when month(conversion_month) >= 2 then year(conversion_month) + 1
                else year(conversion_month)
            end as fiscal_year
        from lead_base
        where 1=1
            and (stage_date_mql_v_2_c is null or convert_timezone('UTC', 'America/Los_Angeles', stage_date_mql_v_2_c::timestamp_ntz) >= convert_timezone('UTC', 'America/Los_Angeles', stage_date_mel_c::timestamp_ntz))
            and convert_timezone('UTC', 'America/Los_Angeles', stage_date_mel_c::timestamp_ntz) > '2023-02-01'
            and status not in ('Customer', 'Partner')
            and email not like '%contentstack%'
        group by conversion_month, sync_date
    ),

    -- MQL to SAL Conversion %
    mql_to_sal_conversion as (
        select
            'MQL TO SAL Conversion %' as metric_name,
            'Lead' as object,
            null as id,
            null as product,
            null as customer_designation,
            null as product_deal_percentage,
            null as stage_date_mel_c,
            null as stage_date_mql_v_2_c,
            null as stage_date_sal_v_2_c,
            null as stage_date_sql_v_2_c,
            null as pipeline_date_c,
            null as close_date,
            null as stage_enter_mqo_c,
            null as license_start_date_c,
            null as predicted_go_live_date_c,
            null as actual_go_live_date_c,
            date_trunc('MONTH', convert_timezone('UTC', 'America/Los_Angeles', stage_date_mql_v_2_c::timestamp_ntz)) as conversion_month,
            null as lost_reason_c,
            null as onboarded_on_time_flag,
            round((count(distinct case when stage_date_sal_v_2_c is not null then id end) * 1.0 / count(distinct id)), 2) as conversion_rate_pct,
            null as total_original_piped_amount,
            null as product_piped_amount,
            null as opp_total_bookings,
            null as product_bookings,
            null as opp_expansion_bookings,
            null as sales_cycle_days,
            null as deployment_days,
            null as geo_c,
            null as owner_region_c,
            null as owner_sub_region_c,
            null as annual_revenue_c,
            null as company_size,
            null as record_type_c,
            null as lead_source,
            null as motion,
            null as lead_source_category_c,
            null as opp_type,
            null as account_name,
            null as matched_account_name_c,
            null as account_tier_c,
            null as deployment_status_c,
            null as type,
            convert_timezone('UTC', 'America/Los_Angeles', _fivetran_synced::timestamp_ntz) as sync_date,
            null as cms_sales_motion_c,
            null as expansion_sales_motion_c,
            null as demand_bucket_c,
            case
                when month(conversion_month) in (2, 3, 4) then 1
                when month(conversion_month) in (5, 6, 7) then 2
                when month(conversion_month) in (8, 9, 10) then 3
                when month(conversion_month) in (11, 12, 1) then 4
            end as fiscal_quarter,
            case
                when month(conversion_month) >= 2 then year(conversion_month) + 1
                else year(conversion_month)
            end as fiscal_year
        from lead_base
        where 1=1
            and (stage_date_sal_v_2_c is null or convert_timezone('UTC', 'America/Los_Angeles', stage_date_sal_v_2_c::timestamp_ntz) >= convert_timezone('UTC', 'America/Los_Angeles', stage_date_mql_v_2_c::timestamp_ntz))
            and convert_timezone('UTC', 'America/Los_Angeles', stage_date_mql_v_2_c::timestamp_ntz) > '2023-02-01'
            and status not in ('Customer', 'Partner')
            and email not like '%contentstack%'
        group by conversion_month, sync_date
    ),

    -- SAL to SQL Conversion %
    sal_to_sql_conversion as (
        select
            'SAL TO SQL Conversion %' as metric_name,
            'Lead' as object,
            null as id,
            null as product,
            null as customer_designation,
            null as product_deal_percentage,
            null as stage_date_mel_c,
            null as stage_date_mql_v_2_c,
            null as stage_date_sal_v_2_c,
            null as stage_date_sql_v_2_c,
            null as pipeline_date_c,
            null as close_date,
            null as stage_enter_mqo_c,
            null as license_start_date_c,
            null as predicted_go_live_date_c,
            null as actual_go_live_date_c,
            date_trunc('MONTH', convert_timezone('UTC', 'America/Los_Angeles', stage_date_sal_v_2_c::timestamp_ntz)) as conversion_month,
            null as lost_reason_c,
            null as onboarded_on_time_flag,
            round((count(distinct case when stage_date_sql_v_2_c is not null then id end) * 1.0 / count(distinct id)), 2) as conversion_rate_pct,
            null as total_original_piped_amount,
            null as product_piped_amount,
            null as opp_total_bookings,
            null as product_bookings,
            null as opp_expansion_bookings,
            null as sales_cycle_days,
            null as deployment_days,
            null as geo_c,
            null as owner_region_c,
            null as owner_sub_region_c,
            null as annual_revenue_c,
            null as company_size,
            null as record_type_c,
            null as lead_source,
            null as motion,
            null as lead_source_category_c,
            null as opp_type,
            null as account_name,
            null as matched_account_name_c,
            null as account_tier_c,
            null as deployment_status_c,
            null as type,
            convert_timezone('UTC', 'America/Los_Angeles', _fivetran_synced::timestamp_ntz) as sync_date,
            null as cms_sales_motion_c,
            null as expansion_sales_motion_c,
            null as demand_bucket_c,
            case
                when month(conversion_month) in (2, 3, 4) then 1
                when month(conversion_month) in (5, 6, 7) then 2
                when month(conversion_month) in (8, 9, 10) then 3
                when month(conversion_month) in (11, 12, 1) then 4
            end as fiscal_quarter,
            case
                when month(conversion_month) >= 2 then year(conversion_month) + 1
                else year(conversion_month)
            end as fiscal_year
        from lead_base
        where 1=1
            and (stage_date_sql_v_2_c is null or convert_timezone('UTC', 'America/Los_Angeles', stage_date_sql_v_2_c::timestamp_ntz) >= convert_timezone('UTC', 'America/Los_Angeles', stage_date_sal_v_2_c::timestamp_ntz))
            and convert_timezone('UTC', 'America/Los_Angeles', stage_date_sal_v_2_c::timestamp_ntz) > '2023-02-01'
            and status not in ('Customer', 'Partner')
            and email not like '%contentstack%'
        group by conversion_month, sync_date
    ),

    -- CDP Pipeline
    cdp_pipeline as (
        select
            'New Pipeline ($)' as metric_name,
            'OPPORTUNITY' as object,
            o.id,
            'Lytics' as product,
            case
                when cdp_pipeline_percentage_c = 100 then 'CDP'
                else 'DXP'
            end as customer_designation,
            cdp_pipeline_percentage_c as product_deal_percentage,
            null as stage_date_mel_c,
            null as stage_date_mql_v_2_c,
            null as stage_date_sal_v_2_c,
            null as stage_date_sql_v_2_c,
            pipeline_date_c,
            null as close_date,
            null as stage_enter_mqo_c,
            null as license_start_date_c,
            null as predicted_go_live_date_c,
            null as actual_go_live_date_c,
            null as conversion_month,
            null as lost_reason_c,
            null as onboarded_on_time_flag,
            null as conversion_rate_pct,
            (total_original_piped_amount_c * (1 / d.conversion_rate)) as total_original_piped_amount,
            (total_original_piped_amount_c * (1 / d.conversion_rate)) * (cdp_pipeline_percentage_c / 100) as product_piped_amount,
            null as opp_total_bookings,
            null as product_bookings,
            null as opp_expansion_bookings,
            null as sales_cycle_days,
            null as deployment_days,
            null as geo_c,
            owner_region_c,
            owner_sub_region_c,
            null as annual_revenue_c,
            case
                when a.customer_segment_c = 'Enterprise Customer' then 'Revenue > $1B'
                when a.customer_segment_c = 'MM Customer' then 'Revenue < $1B'
                else a.customer_segment_c
            end as company_size,
            case 
                when o.record_type_c in ('CPQ Sales', 'Sales', 'Cross-Sell') then 'Cross-Sell'
                when o.record_type_c in ('Upsell', 'CPQ Amendment', 'CPQ Renewal') then 'Upsell'
                else record_type_c
            end as record_type_c,
            lead_source,
            case 
                when o.lead_source_category_c in ('Sales', 'Marketing') then 'GTM'
                when o.lead_source_category_c in ('Partner') then 'Partner'
                when o.lead_source_category_c in ('Customer') then 'Expansion'
                else null
            end as motion,
            o.lead_source_category_c,
            o.type as opp_type,
            a.name as account_name,
            null as matched_account_name_c,
            a.account_tier_c,
            null as deployment_status_c,
            null as type,
            convert_timezone('UTC', 'America/Los_Angeles', o._fivetran_synced::timestamp_ntz) as sync_date,
            o.cms_sales_motion_c,
            o.expansion_sales_motion_c,
            null as demand_bucket_c,
            case
                when month(pipeline_date_c) in (2, 3, 4) then 1
                when month(pipeline_date_c) in (5, 6, 7) then 2
                when month(pipeline_date_c) in (8, 9, 10) then 3
                when month(pipeline_date_c) in (11, 12, 1) then 4
            end as fiscal_quarter,
            case
                when month(pipeline_date_c) >= 2 then year(pipeline_date_c) + 1
                else year(pipeline_date_c)
            end as fiscal_year
        from opportunity_base o
        left join account_base a on o.account_id = a.id
        left join conversion_rate d on o.currency_iso_code = d.iso_code
        where 1=1
            and (
                o.currency_iso_code = 'USD' or
                (
                    o.close_date between d.start_date and d.next_start_date - 1 and
                    d.conversion_rate is not null
                )
            )
            and o.record_type_c in ('CPQ Sales', 'Sales', 'Cross-Sell','CPQ Amendment', 'CPQ Renewal', 'Upsell')
    ),

    -- CMS Pipeline
    cms_pipeline as (
        select
            'New Pipeline ($)' as metric_name,
            'OPPORTUNITY' as object,
            o.id,
            'CS' as product,
            'CMS' as customer_designation,
            case
                when cdp_pipeline_percentage_c is null then 100
                else (100 - cdp_pipeline_percentage_c)
            end as product_deal_percentage,
            null as stage_date_mel_c,
            null as stage_date_mql_v_2_c,
            null as stage_date_sal_v_2_c,
            null as stage_date_sql_v_2_c,
            pipeline_date_c,
            null as close_date,
            null as stage_enter_mqo_c,
            null as license_start_date_c,
            null as predicted_go_live_date_c,
            null as actual_go_live_date_c,
            null as conversion_month,
            null as lost_reason_c,
            null as onboarded_on_time_flag,
            null as conversion_rate_pct,
            (total_original_piped_amount_c * (1 / d.conversion_rate)) as total_original_piped_amount,
            (total_original_piped_amount_c * (1 / d.conversion_rate)) * (product_deal_percentage / 100) as product_piped_amount,
            null as opp_total_bookings,
            null as product_bookings,
            null as opp_expansion_bookings,
            null as sales_cycle_days,
            null as deployment_days,
            null as geo_c,
            owner_region_c,
            owner_sub_region_c,
            null as annual_revenue_c,
            case
                when a.customer_segment_c = 'Enterprise Customer' then 'Revenue > $1B'
                when a.customer_segment_c = 'MM Customer' then 'Revenue < $1B'
                else a.customer_segment_c
            end as company_size,
            case 
                when o.record_type_c in ('CPQ Sales', 'Sales', 'Cross-Sell') then 'Cross-Sell'
                when o.record_type_c in ('Upsell', 'CPQ Amendment', 'CPQ Renewal') then 'Upsell'
                else record_type_c
            end as record_type_c,
            lead_source,
            case 
                when o.lead_source_category_c in ('Sales', 'Marketing') then 'GTM'
                when o.lead_source_category_c in ('Partner') then 'Partner'
                when o.lead_source_category_c in ('Customer') then 'Expansion'
                else null
            end as motion,
            o.lead_source_category_c,
            o.type as opp_type,
            a.name as account_name,
            null as matched_account_name_c,
            a.account_tier_c,
            null as deployment_status_c,
            null as type,
            convert_timezone('UTC', 'America/Los_Angeles', o._fivetran_synced::timestamp_ntz) as sync_date,
            o.cms_sales_motion_c,
            o.expansion_sales_motion_c,
            null as demand_bucket_c,
            case
                when month(pipeline_date_c) in (2, 3, 4) then 1
                when month(pipeline_date_c) in (5, 6, 7) then 2
                when month(pipeline_date_c) in (8, 9, 10) then 3
                when month(pipeline_date_c) in (11, 12, 1) then 4
            end as fiscal_quarter,
            case
                when month(pipeline_date_c) >= 2 then year(pipeline_date_c) + 1
                else year(pipeline_date_c)
            end as fiscal_year
        from opportunity_base o
        left join account_base a on o.account_id = a.id
        left join conversion_rate d on o.currency_iso_code = d.iso_code
        where 1=1
            and (
                o.currency_iso_code = 'USD' or
                (
                    o.close_date between d.start_date and d.next_start_date - 1 and
                    d.conversion_rate is not null
                )
            )
            and o.record_type_c in ('CPQ Sales', 'Sales', 'Cross-Sell','CPQ Amendment', 'CPQ Renewal', 'Upsell')
    ),

    -- CDP Bookings
    cdp_bookings as (
        select
            'Bookings ($)' as metric_name,
            'OPPORTUNITY' as object,
            o.id,
            'Lytics' as product,
            case
                when cdp_pipeline_percentage_c = 100 then 'CDP'
                else 'DXP'
            end as customer_designation,
            cdp_deal_percentage_c as product_deal_percentage,
            null as stage_date_mel_c,
            null as stage_date_mql_v_2_c,
            null as stage_date_sal_v_2_c,
            null as stage_date_sql_v_2_c,
            pipeline_date_c,
            close_date,
            null as stage_enter_mqo_c,
            null as license_start_date_c,
            null as predicted_go_live_date_c,
            null as actual_go_live_date_c,
            null as conversion_month,
            null as lost_reason_c,
            null as onboarded_on_time_flag,
            null as conversion_rate_pct,
            null as total_original_piped_amount,
            null as product_piped_amount,
            (opp_total_bookings_c * (1 / d.conversion_rate)) as opp_total_bookings,
            (opp_total_bookings_c * (1 / d.conversion_rate)) * (cdp_deal_percentage_c / 100) as product_bookings,
            null as opp_expansion_bookings,
            null as sales_cycle_days,
            null as deployment_days,
            null as geo_c,
            owner_region_c,
            owner_sub_region_c,
            null as annual_revenue_c,
            case
                when a.customer_segment_c = 'Enterprise Customer' then 'Revenue > $1B'
                when a.customer_segment_c = 'MM Customer' then 'Revenue < $1B'
                else a.customer_segment_c
            end as company_size,
            case 
                when o.record_type_c in ('CPQ Sales', 'Sales', 'Cross-Sell') then 'Cross-Sell'
                when o.record_type_c in ('Upsell', 'CPQ Amendment', 'CPQ Renewal') then 'Upsell'
                else record_type_c
            end as record_type_c,
            lead_source,
            case 
                when o.lead_source_category_c in ('Sales', 'Marketing') then 'GTM'
                when o.lead_source_category_c in ('Partner') then 'Partner'
                when o.lead_source_category_c in ('Customer') then 'Expansion'
                else null
            end as motion,
            o.lead_source_category_c,
            o.type as opp_type,
            a.name as account_name,
            null as matched_account_name_c,
            a.account_tier_c,
            null as deployment_status_c,
            null as type,
            convert_timezone('UTC', 'America/Los_Angeles', o._fivetran_synced::timestamp_ntz) as sync_date,
            o.cms_sales_motion_c,
            o.expansion_sales_motion_c,
            null as demand_bucket_c,
            case
                when month(close_date) in (2, 3, 4) then 1
                when month(close_date) in (5, 6, 7) then 2
                when month(close_date) in (8, 9, 10) then 3
                when month(close_date) in (11, 12, 1) then 4
            end as fiscal_quarter,
            case
                when month(close_date) >= 2 then year(close_date) + 1
                else year(close_date)
            end as fiscal_year
        from opportunity_base o
        left join account_base a on o.account_id = a.id
        left join conversion_rate d on o.currency_iso_code = d.iso_code
        where 1=1
            and (
                o.currency_iso_code = 'USD' or
                (
                    o.close_date between d.start_date and d.next_start_date - 1 and
                    d.conversion_rate is not null
                )
            )
            and o.stage_name = 'Closed Won'
            and o.record_type_c in ('CPQ Sales', 'Sales', 'Cross-Sell', 'CPQ Amendment', 'CPQ Renewal', 'Upsell')
            and o.opp_total_bookings_c > 0
            and o.pipeline_date_c is not null
    ),

    -- CMS Bookings
    cms_bookings as (
        select
            'Bookings ($)' as metric_name,
            'OPPORTUNITY' as object,
            o.id,
            'CS' as product,
            'CMS' as customer_designation,
            case
                when cdp_deal_percentage_c is null then 100
                else 100 - cdp_deal_percentage_c
            end as product_deal_percentage,
            null as stage_date_mel_c,
            null as stage_date_mql_v_2_c,
            null as stage_date_sal_v_2_c,
            null as stage_date_sql_v_2_c,
            pipeline_date_c,
            close_date,
            null as stage_enter_mqo_c,
            null as license_start_date_c,
            null as predicted_go_live_date_c,
            null as actual_go_live_date_c,
            null as conversion_month,
            null as lost_reason_c,
            null as onboarded_on_time_flag,
            null as conversion_rate_pct,
            null as total_original_piped_amount,
            null as product_piped_amount,
            (opp_total_bookings_c * (1 / d.conversion_rate)) as opp_total_bookings,
            case
                when opp_total_bookings_c is null then null
                else (opp_total_bookings_c * (1 / d.conversion_rate)) * (product_deal_percentage / 100)
            end as product_bookings,
            null as opp_expansion_bookings,
            null as sales_cycle_days,
            null as deployment_days,
            null as geo_c,
            owner_region_c,
            owner_sub_region_c,
            null as annual_revenue_c,
            case
                when a.customer_segment_c = 'Enterprise Customer' then 'Revenue > $1B'
                when a.customer_segment_c = 'MM Customer' then 'Revenue < $1B'
                else a.customer_segment_c
            end as company_size,
            case 
                when o.record_type_c in ('CPQ Sales', 'Sales', 'Cross-Sell') then 'Cross-Sell'
                when o.record_type_c in ('Upsell', 'CPQ Amendment', 'CPQ Renewal') then 'Upsell'
                else record_type_c
            end as record_type_c,
            lead_source,
            case 
                when o.lead_source_category_c in ('Sales', 'Marketing') then 'GTM'
                when o.lead_source_category_c in ('Partner') then 'Partner'
                when o.lead_source_category_c in ('Customer') then 'Expansion'
                else null
            end as motion,
            o.lead_source_category_c,
            o.type as opp_type,
            a.name as account_name,
            null as matched_account_name_c,
            a.account_tier_c,
            null as deployment_status_c,
            null as type,
            convert_timezone('UTC', 'America/Los_Angeles', o._fivetran_synced::timestamp_ntz) as sync_date,
            o.cms_sales_motion_c,
            o.expansion_sales_motion_c,
            null as demand_bucket_c,
            case
                when month(close_date) in (2, 3, 4) then 1
                when month(close_date) in (5, 6, 7) then 2
                when month(close_date) in (8, 9, 10) then 3
                when month(close_date) in (11, 12, 1) then 4
            end as fiscal_quarter,
            case
                when month(close_date) >= 2 then year(close_date) + 1
                else year(close_date)
            end as fiscal_year
        from opportunity_base o
        left join account_base a on o.account_id = a.id
        left join conversion_rate d on o.currency_iso_code = d.iso_code
        where 1=1
            and (
                o.currency_iso_code = 'USD' or
                (
                    o.close_date between d.start_date and d.next_start_date - 1 and
                    d.conversion_rate is not null
                )
            )
            and o.stage_name = 'Closed Won'
            and o.record_type_c in ('CPQ Sales', 'Sales', 'Cross-Sell', 'CPQ Amendment', 'CPQ Renewal', 'Upsell')
            and o.opp_total_bookings_c > 0
            and o.pipeline_date_c is not null
    ),

    -- Closed Won Opps
    closed_won_opps as (
        select
            'Closed Won Opps' as metric_name,
            'OPPORTUNITY' as object,
            o.id,
            null as product,
            null as customer_designation,
            null as product_deal_percentage,
            null as stage_date_mel_c,
            null as stage_date_mql_v_2_c,
            null as stage_date_sal_v_2_c,
            null as stage_date_sql_v_2_c,
            pipeline_date_c,
            close_date,
            null as stage_enter_mqo_c,
            null as license_start_date_c,
            null as predicted_go_live_date_c,
            null as actual_go_live_date_c,
            null as conversion_month,
            null as lost_reason_c,
            null as onboarded_on_time_flag,
            null as conversion_rate_pct,
            null as total_original_piped_amount,
            null as product_piped_amount,
            (opp_total_bookings_c * (1 / d.conversion_rate)) as opp_total_bookings,
            null as product_bookings,
            null as opp_expansion_bookings,
            null as sales_cycle_days,
            null as deployment_days,
            null as geo_c,
            owner_region_c,
            owner_sub_region_c,
            null as annual_revenue_c,
            case
                when a.customer_segment_c = 'Enterprise Customer' then 'Revenue > $1B'
                when a.customer_segment_c = 'MM Customer' then 'Revenue < $1B'
                else a.customer_segment_c
            end as company_size,
            case 
                when o.record_type_c in ('CPQ Sales', 'Sales', 'Cross-Sell') then 'Cross-Sell'
                when o.record_type_c in ('Upsell', 'CPQ Amendment', 'CPQ Renewal') then 'Upsell'
                else record_type_c
            end as record_type_c,
            lead_source,
            case 
                when o.lead_source_category_c in ('Sales', 'Marketing') then 'GTM'
                when o.lead_source_category_c in ('Partner') then 'Partner'
                when o.lead_source_category_c in ('Customer') then 'Expansion'
                else null
            end as motion,
            o.lead_source_category_c,
            o.type as opp_type,
            a.name as account_name,
            null as matched_account_name_c,
            a.account_tier_c,
            null as deployment_status_c,
            null as type,
            convert_timezone('UTC', 'America/Los_Angeles', o._fivetran_synced::timestamp_ntz) as sync_date,
            o.cms_sales_motion_c,
            o.expansion_sales_motion_c,
            null as demand_bucket_c,
            case
                when month(close_date) in (2, 3, 4) then 1
                when month(close_date) in (5, 6, 7) then 2
                when month(close_date) in (8, 9, 10) then 3
                when month(close_date) in (11, 12, 1) then 4
            end as fiscal_quarter,
            case
                when month(close_date) >= 2 then year(close_date) + 1
                else year(close_date)
            end as fiscal_year
        from opportunity_base o
        left join account_base a on o.account_id = a.id
        left join conversion_rate d on o.currency_iso_code = d.iso_code
        where 1=1
            and (
                o.currency_iso_code = 'USD' or
                (
                    o.close_date between d.start_date and d.next_start_date - 1 and
                    d.conversion_rate is not null
                )
            )
            and o.stage_name = 'Closed Won'
            and o.record_type_c in ('CPQ Sales', 'Sales', 'Cross-Sell', 'CPQ Amendment', 'CPQ Renewal', 'Upsell')
    ),

    -- Avg Sales Cycle (Days)
    avg_sales_cycle as (
        select
            'Avg Sales Cycle (Days)' as metric_name,
            'OPPORTUNITY' as object,
            o.id,
            null as product,
            null as customer_designation,
            null as product_deal_percentage,
            null as stage_date_mel_c,
            null as stage_date_mql_v_2_c,
            null as stage_date_sal_v_2_c,
            null as stage_date_sql_v_2_c,
            pipeline_date_c,
            close_date,
            null as stage_enter_mqo_c,
            null as license_start_date_c,
            null as predicted_go_live_date_c,
            null as actual_go_live_date_c,
            null as conversion_month,
            null as lost_reason_c,
            null as onboarded_on_time_flag,
            null as conversion_rate_pct,
            null as total_original_piped_amount,
            null as product_piped_amount,
            null as opp_total_bookings,
            null as product_bookings,
            null as opp_expansion_bookings,
            (close_date - pipeline_date_c) as sales_cycle_days,
            null as deployment_days,
            null as geo_c,
            owner_region_c,
            owner_sub_region_c,
            null as annual_revenue_c,
            case
                when a.customer_segment_c = 'Enterprise Customer' then 'Revenue > $1B'
                when a.customer_segment_c = 'MM Customer' then 'Revenue < $1B'
                else a.customer_segment_c
            end as company_size,
            case 
                when o.record_type_c in ('CPQ Sales', 'Sales', 'Cross-Sell') then 'Cross-Sell'
                when o.record_type_c in ('Upsell', 'CPQ Amendment', 'CPQ Renewal') then 'Upsell'
                else record_type_c
            end as record_type_c,
            lead_source,
            case 
                when o.lead_source_category_c in ('Sales', 'Marketing') then 'GTM'
                when o.lead_source_category_c in ('Partner') then 'Partner'
                when o.lead_source_category_c in ('Customer') then 'Expansion'
                else null
            end as motion,
            o.lead_source_category_c,
            o.type as opp_type,
            a.name as account_name,
            null as matched_account_name_c,
            a.account_tier_c,
            null as deployment_status_c,
            null as type,
            convert_timezone('UTC', 'America/Los_Angeles', o._fivetran_synced::timestamp_ntz) as sync_date,
            o.cms_sales_motion_c,
            o.expansion_sales_motion_c,
            null as demand_bucket_c,
            case
                when month(pipeline_date_c) in (2, 3, 4) then 1
                when month(pipeline_date_c) in (5, 6, 7) then 2
                when month(pipeline_date_c) in (8, 9, 10) then 3
                when month(pipeline_date_c) in (11, 12, 1) then 4
            end as fiscal_quarter,
            case
                when month(pipeline_date_c) >= 2 then year(pipeline_date_c) + 1
                else year(pipeline_date_c)
            end as fiscal_year
        from opportunity_base o
        left join account_base a on o.account_id = a.id
        where 1=1
            and o.stage_name = 'Closed Won'
            and o.record_type_c in ('CPQ Sales', 'Sales', 'Cross-Sell', 'CPQ Amendment', 'CPQ Renewal', 'Upsell')
    ),

    -- Closed Lost Reason
    closed_lost_reason as (
        select
            'Closed Lost Reason' as metric_name,
            'OPPORTUNITY' as object,
            o.id,
            null as product,
            null as customer_designation,
            null as product_deal_percentage,
            null as stage_date_mel_c,
            null as stage_date_mql_v_2_c,
            null as stage_date_sal_v_2_c,
            null as stage_date_sql_v_2_c,
            pipeline_date_c,
            close_date,
            null as stage_enter_mqo_c,
            null as license_start_date_c,
            null as predicted_go_live_date_c,
            null as actual_go_live_date_c,
            null as conversion_month,
            lost_reason_c,
            null as onboarded_on_time_flag,
            null as conversion_rate_pct,
            null as total_original_piped_amount,
            null as product_piped_amount,
            (opp_total_bookings_c * (1 / d.conversion_rate)) as opp_total_bookings,
            null as product_bookings,
            null as opp_expansion_bookings,
            null as sales_cycle_days,
            null as deployment_days,
            null as geo_c,
            owner_region_c,
            owner_sub_region_c,
            null as annual_revenue_c,
            case
                when a.customer_segment_c = 'Enterprise Customer' then 'Revenue > $1B'
                when a.customer_segment_c = 'MM Customer' then 'Revenue < $1B'
                else a.customer_segment_c
            end as company_size,
            case 
                when o.record_type_c in ('CPQ Sales', 'Sales', 'Cross-Sell') then 'Cross-Sell'
                when o.record_type_c in ('Upsell', 'CPQ Amendment', 'CPQ Renewal') then 'Upsell'
                else record_type_c
            end as record_type_c,
            lead_source,
            case 
                when o.lead_source_category_c in ('Sales', 'Marketing') then 'GTM'
                when o.lead_source_category_c in ('Partner') then 'Partner'
                when o.lead_source_category_c in ('Customer') then 'Expansion'
                else null
            end as motion,
            o.lead_source_category_c,
            o.type as opp_type,
            a.name as account_name,
            null as matched_account_name_c,
            a.account_tier_c,
            null as deployment_status_c,
            null as type,
            convert_timezone('UTC', 'America/Los_Angeles', o._fivetran_synced::timestamp_ntz) as sync_date,
            o.cms_sales_motion_c,
            o.expansion_sales_motion_c,
            null as demand_bucket_c,
            case
                when month(close_date) in (2, 3, 4) then 1
                when month(close_date) in (5, 6, 7) then 2
                when month(close_date) in (8, 9, 10) then 3
                when month(close_date) in (11, 12, 1) then 4
            end as fiscal_quarter,
            case
                when month(close_date) >= 2 then year(close_date) + 1
                else year(close_date)
            end as fiscal_year
        from opportunity_base o
        left join account_base a on o.account_id = a.id
        left join conversion_rate d on o.currency_iso_code = d.iso_code
        where 1=1
            and (
                o.currency_iso_code = 'USD' or
                (
                    o.close_date between d.start_date and d.next_start_date - 1 and
                    d.conversion_rate is not null
                )
            )
            and o.stage_name = 'Closed Lost'
            and o.record_type_c in ('CPQ Sales', 'Sales', 'Cross-Sell', 'CPQ Amendment', 'CPQ Renewal', 'Upsell')
    ),

    -- Expansion Bookings
    expansion_bookings as (
        select
            'Expansion Bookings' as metric_name,
            'OPPORTUNITY' as object,
            o.id,
            null as product,
            null as customer_designation,
            null as product_deal_percentage,
            null as stage_date_mel_c,
            null as stage_date_mql_v_2_c,
            null as stage_date_sal_v_2_c,
            null as stage_date_sql_v_2_c,
            null as pipeline_date_c,
            close_date,
            null as stage_enter_mqo_c,
            null as license_start_date_c,
            null as predicted_go_live_date_c,
            null as actual_go_live_date_c,
            null as conversion_month,
            null as lost_reason_c,
            null as onboarded_on_time_flag,
            null as conversion_rate_pct,
            null as total_original_piped_amount,
            null as product_piped_amount,
            (opp_total_bookings_c * (1 / d.conversion_rate)) as opp_total_bookings,
            null as product_bookings,
            null as opp_expansion_bookings,
            null as sales_cycle_days,
            null as deployment_days,
            null as geo_c,
            owner_region_c,
            owner_sub_region_c,
            null as annual_revenue_c,
            case
                when a.customer_segment_c = 'Enterprise Customer' then 'Revenue > $1B'
                when a.customer_segment_c = 'MM Customer' then 'Revenue < $1B'
                else a.customer_segment_c
            end as company_size,
            case 
                when o.record_type_c in ('CPQ Sales', 'Sales', 'Cross-Sell') then 'Cross-Sell'
                when o.record_type_c in ('Upsell', 'CPQ Amendment', 'CPQ Renewal') then 'Upsell'
                else record_type_c
            end as record_type_c,
            lead_source,
            case 
                when o.lead_source_category_c in ('Sales', 'Marketing') then 'GTM'
                when o.lead_source_category_c in ('Partner') then 'Partner'
                when o.lead_source_category_c in ('Customer') then 'Expansion'
                else null
            end as motion,
            o.lead_source_category_c,
            o.type as opp_type,
            a.name as account_name,
            null as matched_account_name_c,
            a.account_tier_c,
            null as deployment_status_c,
            null as type,
            convert_timezone('UTC', 'America/Los_Angeles', o._fivetran_synced::timestamp_ntz) as sync_date,
            o.cms_sales_motion_c,
            o.expansion_sales_motion_c,
            null as demand_bucket_c,
            case
                when month(close_date) in (2, 3, 4) then 1
                when month(close_date) in (5, 6, 7) then 2
                when month(close_date) in (8, 9, 10) then 3
                when month(close_date) in (11, 12, 1) then 4
            end as fiscal_quarter,
            case
                when month(close_date) >= 2 then year(close_date) + 1
                else year(close_date)
            end as fiscal_year
        from opportunity_base o
        left join account_base a on o.account_id = a.id
        left join conversion_rate d on o.currency_iso_code = d.iso_code
        where 1=1
            and stage_name = 'Closed Won'
            and o.record_type_c in ('CPQ Sales', 'Sales', 'Cross-Sell', 'CPQ Amendment', 'CPQ Renewal', 'Upsell')
            and (
                o.currency_iso_code = 'USD' or
                (
                    o.close_date between d.start_date and d.next_start_date - 1 and
                    d.conversion_rate is not null
                )
            )
    ),

    -- Time to Deploy (Days)
    time_to_deploy as (
        select
            'Time to Deploy (Days)' as metric_name,
            'ACCOUNT' as object,
            null as id,
            null as product,
            null as customer_designation,
            null as product_deal_percentage,
            null as stage_date_mel_c,
            null as stage_date_mql_v_2_c,
            null as stage_date_sal_v_2_c,
            null as stage_date_sql_v_2_c,
            null as pipeline_date_c,
            null as close_date,
            null as stage_enter_mqo_c,
            license_start_date_c,
            null as predicted_go_live_date_c,
            actual_go_live_date_c,
            null as conversion_month,
            null as lost_reason_c,
            null as onboarded_on_time_flag,
            null as conversion_rate_pct,
            null as total_original_piped_amount,
            null as product_piped_amount,
            null as opp_total_bookings,
            null as product_bookings,
            null as opp_expansion_bookings,
            null as sales_cycle_days,
            (actual_go_live_date_c - license_start_date_c) as deployment_days,
            geo_c,
            region_c as owner_region_c,
            sub_region_c as owner_sub_region_c,
            revenue_c as annual_revenue_c,
            case
                when customer_segment_c = 'Enterprise Customer' then 'Revenue > $1B'
                when customer_segment_c = 'MM Customer' then 'Revenue < $1B'
                else customer_segment_c
            end as company_size,
            null as record_type_c,
            null as lead_source,
            null as motion,
            null as lead_source_category_c,
            null as opp_type,
            null as account_name,
            null as matched_account_name_c,
            null as account_tier_c,
            deployment_status_c,
            type,
            convert_timezone('UTC', 'America/Los_Angeles', _fivetran_synced::timestamp_ntz) as sync_date,
            null as cms_sales_motion_c,
            null as expansion_sales_motion_c,
            null as demand_bucket_c,
            case
                when month(license_start_date_c) in (2, 3, 4) then 1
                when month(license_start_date_c) in (5, 6, 7) then 2
                when month(license_start_date_c) in (8, 9, 10) then 3
                when month(license_start_date_c) in (11, 12, 1) then 4
            end as fiscal_quarter,
            case
                when month(license_start_date_c) >= 2 then year(license_start_date_c) + 1
                else year(license_start_date_c)
            end as fiscal_year
        from account_base
        where 1=1
            and deployment_status_c in ('Deployed', 'Multi-Deployment')
    ),

    -- % Onboarded within Target Date
    onboarded_within_target as (
        select
            '% Onboarded within Target Date' as metric_name,
            'ACCOUNT' as object,
            null as id,
            null as product,
            null as customer_designation,
            null as product_deal_percentage,
            null as stage_date_mel_c,
            null as stage_date_mql_v_2_c,
            null as stage_date_sal_v_2_c,
            null as stage_date_sql_v_2_c,
            null as pipeline_date_c,
            null as close_date,
            null as stage_enter_mqo_c,
            null as license_start_date_c,
            predicted_go_live_date_c,
            actual_go_live_date_c,
            null as conversion_month,
            null as lost_reason_c,
            case
                when actual_go_live_date_c <= predicted_go_live_date_c then 'Yes'
                else 'No'
            end as onboarded_on_time_flag,
            null as conversion_rate_pct,
            null as total_original_piped_amount,
            null as product_piped_amount,
            null as opp_total_bookings,
            null as product_bookings,
            null as opp_expansion_bookings,
            null as sales_cycle_days,
            null as deployment_days,
            geo_c,
            region_c as owner_region_c,
            sub_region_c as owner_sub_region_c,
            revenue_c as annual_revenue_c,
            case
                when customer_segment_c = 'Enterprise Customer' then 'Revenue > $1B'
                when customer_segment_c = 'MM Customer' then 'Revenue < $1B'
                else customer_segment_c
            end as company_size,
            null as record_type_c,
            null as lead_source,
            null as motion,
            null as lead_source_category_c,
            null as opp_type,
            name as account_name,
            null as matched_account_name_c,
            null as account_tier_c,
            deployment_status_c,
            type,
            convert_timezone('UTC', 'America/Los_Angeles', _fivetran_synced::timestamp_ntz) as sync_date,
            null as cms_sales_motion_c,
            null as expansion_sales_motion_c,
            null as demand_bucket_c,
            case
                when month(predicted_go_live_date_c) in (2, 3, 4) then 1
                when month(predicted_go_live_date_c) in (5, 6, 7) then 2
                when month(predicted_go_live_date_c) in (8, 9, 10) then 3
                when month(predicted_go_live_date_c) in (11, 12, 1) then 4
            end as fiscal_quarter,
            case
                when month(predicted_go_live_date_c) >= 2 then year(predicted_go_live_date_c) + 1
                else year(predicted_go_live_date_c)
            end as fiscal_year
        from account_base
        where 1=1
            and actual_go_live_date_c is not null and deployment_status_c in ('Deployed','Multi-Deployment')
            and type = 'Customer'
    ),

    -- Renewals with Expansion (%)
    renewals_with_expansion as (
        select
            'Renewals with Expansion (%)' as metric_name,
            'OPPORTUNITY' as object,
            o.id,
            null as product,
            null as customer_designation,
            null as product_deal_percentage,
            null as stage_date_mel_c,
            null as stage_date_mql_v_2_c,
            null as stage_date_sal_v_2_c,
            null as stage_date_sql_v_2_c,
            null as pipeline_date_c,
            to_date(o.close_date) as close_date,
            null as stage_enter_mqo_c,
            null as license_start_date_c,
            null as predicted_go_live_date_c,
            null as actual_go_live_date_c,
            null as conversion_month,
            null as lost_reason_c,
            null as onboarded_on_time_flag,
            null as conversion_rate_pct,
            null as total_original_piped_amount,
            null as product_piped_amount,
            null as opp_total_bookings,
            null as product_bookings,
            (opp_expansion_bookings_c * (1 / d.conversion_rate)) as opp_expansion_bookings,
            null as sales_cycle_days,
            null as deployment_days,
            null as geo_c,
            owner_region_c,
            owner_sub_region_c,
            null as annual_revenue_c,
            case
                when a.customer_segment_c = 'Enterprise Customer' then 'Revenue > $1B'
                when a.customer_segment_c = 'MM Customer' then 'Revenue < $1B'
                else a.customer_segment_c
            end as company_size,
            o.record_type_c,
            lead_source,
            case 
                when o.lead_source_category_c in ('Sales', 'Marketing') then 'GTM'
                when o.lead_source_category_c in ('Partner') then 'Partner'
                when o.lead_source_category_c in ('Customer') then 'Expansion'
                else null
            end as motion,
            o.lead_source_category_c,
            o.type as opp_type,
            a.name as account_name,
            null as matched_account_name_c,
            a.account_tier_c,
            null as deployment_status_c,
            null as type,
            convert_timezone('UTC', 'America/Los_Angeles', o._fivetran_synced::timestamp_ntz) as sync_date,
            o.cms_sales_motion_c,
            o.expansion_sales_motion_c,
            null as demand_bucket_c,
            case
                when month(to_date(o.close_date)) in (2, 3, 4) then 1
                when month(to_date(o.close_date)) in (5, 6, 7) then 2
                when month(to_date(o.close_date)) in (8, 9, 10) then 3
                when month(to_date(o.close_date)) in (11, 12, 1) then 4
            end as fiscal_quarter,
            case
                when month(to_date(o.close_date)) >= 2 then year(to_date(o.close_date)) + 1
                else year(to_date(o.close_date))
            end as fiscal_year
        from opportunity_base o
        left join account_base a on o.account_id = a.id
        left join conversion_rate d on o.currency_iso_code = d.iso_code
        where 1=1
            and (
                o.currency_iso_code = 'USD' or
                (
                    o.close_date between d.start_date and d.next_start_date - 1 and
                    d.conversion_rate is not null
                )
            )
            and o.record_type_c = 'CPQ Renewal'
            and o.is_won = 'TRUE'
            and to_date(o.close_date) >= '2024-02-01'
    ),

    -- ASC (Days) by Sales Motion (New Biz)
    asc_sales_motion_new_biz as (
        select
            'ASC (Days) by Sales Motion (New Biz)' as metric_name,
            'OPPORTUNITY' as object,
            o.id,
            null as product,
            null as customer_designation,
            null as product_deal_percentage,
            null as stage_date_mel_c,
            null as stage_date_mql_v_2_c,
            null as stage_date_sal_v_2_c,
            null as stage_date_sql_v_2_c,
            pipeline_date_c,
            close_date,
            null as stage_enter_mqo_c,
            null as license_start_date_c,
            null as predicted_go_live_date_c,
            null as actual_go_live_date_c,
            null as conversion_month,
            null as lost_reason_c,
            null as onboarded_on_time_flag,
            null as conversion_rate_pct,
            null as total_original_piped_amount,
            null as product_piped_amount,
            null as opp_total_bookings,
            null as product_bookings,
            null as opp_expansion_bookings,
            (close_date - pipeline_date_c) as sales_cycle_days,
            null as deployment_days,
            null as geo_c,
            owner_region_c,
            owner_sub_region_c,
            null as annual_revenue_c,
            case
                when a.customer_segment_c = 'Enterprise Customer' then 'Revenue > $1B'
                when a.customer_segment_c = 'MM Customer' then 'Revenue < $1B'
                else a.customer_segment_c
            end as company_size,
            case 
                when o.record_type_c in ('CPQ Sales', 'Sales', 'Cross-Sell') then 'Cross-Sell'
                when o.record_type_c in ('Upsell', 'CPQ Amendment', 'CPQ Renewal') then 'Upsell'
                else record_type_c
            end as record_type_c,
            lead_source,
            case 
                when o.lead_source_category_c in ('Sales', 'Marketing') then 'GTM'
                when o.lead_source_category_c in ('Partner') then 'Partner'
                when o.lead_source_category_c in ('Customer') then 'Expansion'
                else null
            end as motion,
            o.lead_source_category_c,
            o.type as opp_type,
            a.name as account_name,
            null as matched_account_name_c,
            a.account_tier_c,
            null as deployment_status_c,
            null as type,
            convert_timezone('UTC', 'America/Los_Angeles', o._fivetran_synced::timestamp_ntz) as sync_date,
            o.cms_sales_motion_c,
            o.expansion_sales_motion_c,
            null as demand_bucket_c,
            case
                when month(pipeline_date_c) in (2, 3, 4) then 1
                when month(pipeline_date_c) in (5, 6, 7) then 2
                when month(pipeline_date_c) in (8, 9, 10) then 3
                when month(pipeline_date_c) in (11, 12, 1) then 4
            end as fiscal_quarter,
            case
                when month(pipeline_date_c) >= 2 then year(pipeline_date_c) + 1
                else year(pipeline_date_c)
            end as fiscal_year
        from opportunity_base o
        left join account_base a on o.account_id = a.id
        where 1=1
            and o.type = 'New Business'
            and o.stage_name = 'Closed Won'
            and o.record_type_c in ('CPQ Sales', 'Sales', 'Cross-Sell', 'CPQ Amendment', 'CPQ Renewal', 'Upsell')
    ),

    -- ASC (Days) by Expansion Motion (Existing Biz)
    asc_expansion_motion_existing_biz as (
        select
            'ASC (Days) by Expansion Motion (Existing Biz)' as metric_name,
            'OPPORTUNITY' as object,
            o.id,
            null as product,
            null as customer_designation,
            null as product_deal_percentage,
            null as stage_date_mel_c,
            null as stage_date_mql_v_2_c,
            null as stage_date_sal_v_2_c,
            null as stage_date_sql_v_2_c,
            pipeline_date_c,
            close_date,
            null as stage_enter_mqo_c,
            null as license_start_date_c,
            null as predicted_go_live_date_c,
            null as actual_go_live_date_c,
            null as conversion_month,
            null as lost_reason_c,
            null as onboarded_on_time_flag,
            null as conversion_rate_pct,
            null as total_original_piped_amount,
            null as product_piped_amount,
            null as opp_total_bookings,
            null as product_bookings,
            null as opp_expansion_bookings,
            (close_date - pipeline_date_c) as sales_cycle_days,
            null as deployment_days,
            null as geo_c,
            owner_region_c,
            owner_sub_region_c,
            null as annual_revenue_c,
            case
                when a.customer_segment_c = 'Enterprise Customer' then 'Revenue > $1B'
                when a.customer_segment_c = 'MM Customer' then 'Revenue < $1B'
                else a.customer_segment_c
            end as company_size,
            case 
                when o.record_type_c in ('CPQ Sales', 'Sales', 'Cross-Sell') then 'Cross-Sell'
                when o.record_type_c in ('Upsell', 'CPQ Amendment', 'CPQ Renewal') then 'Upsell'
                else record_type_c
            end as record_type_c,
            lead_source,
            case 
                when o.lead_source_category_c in ('Sales', 'Marketing') then 'GTM'
                when o.lead_source_category_c in ('Partner') then 'Partner'
                when o.lead_source_category_c in ('Customer') then 'Expansion'
                else null
            end as motion,
            o.lead_source_category_c,
            o.type as opp_type,
            a.name as account_name,
            null as matched_account_name_c,
            a.account_tier_c,
            null as deployment_status_c,
            null as type,
            convert_timezone('UTC', 'America/Los_Angeles', o._fivetran_synced::timestamp_ntz) as sync_date,
            o.cms_sales_motion_c,
            o.expansion_sales_motion_c,
            null as demand_bucket_c,
            case
                when month(pipeline_date_c) in (2, 3, 4) then 1
                when month(pipeline_date_c) in (5, 6, 7) then 2
                when month(pipeline_date_c) in (8, 9, 10) then 3
                when month(pipeline_date_c) in (11, 12, 1) then 4
            end as fiscal_quarter,
            case
                when month(pipeline_date_c) >= 2 then year(pipeline_date_c) + 1
                else year(pipeline_date_c)
            end as fiscal_year
        from opportunity_base o
        left join account_base a on o.account_id = a.id
        where 1=1
            and o.type = 'Existing Business'
            and o.stage_name = 'Closed Won'
            and o.record_type_c in ('CPQ Sales', 'Sales', 'Cross-Sell', 'CPQ Amendment', 'CPQ Renewal', 'Upsell')
    ),

    -- MQO Volume
    mqo_volume as (
        select
            'MQO Volume' as metric_name,
            'OPPORTUNITY' as object,
            o.id,
            null as product,
            null as customer_designation,
            null as product_deal_percentage,
            null as stage_date_mel_c,
            null as stage_date_mql_v_2_c,
            null as stage_date_sal_v_2_c,
            null as stage_date_sql_v_2_c,
            pipeline_date_c,
            null as close_date,
            stage_enter_mqo_c,
            null as license_start_date_c,
            null as predicted_go_live_date_c,
            null as actual_go_live_date_c,
            null as conversion_month,
            null as lost_reason_c,
            null as onboarded_on_time_flag,
            null as conversion_rate_pct,
            (total_original_piped_amount_c * (1 / d.conversion_rate)) as total_original_piped_amount,
            null as product_piped_amount,
            null as opp_total_bookings,
            null as product_bookings,
            null as opp_expansion_bookings,
            null as sales_cycle_days,
            null as deployment_days,
            null as geo_c,
            owner_region_c,
            owner_sub_region_c,
            null as annual_revenue_c,
            case
                when a.customer_segment_c = 'Enterprise Customer' then 'Revenue > $1B'
                when a.customer_segment_c = 'MM Customer' then 'Revenue < $1B'
                else a.customer_segment_c
            end as company_size,
            case 
                when o.record_type_c in ('CPQ Sales', 'Sales', 'Cross-Sell') then 'Cross-Sell'
                when o.record_type_c in ('Upsell', 'CPQ Amendment', 'CPQ Renewal') then 'Upsell'
                else record_type_c
            end as record_type_c,
            lead_source,
            case 
                when o.lead_source_category_c in ('Sales', 'Marketing') then 'GTM'
                when o.lead_source_category_c in ('Partner') then 'Partner'
                when o.lead_source_category_c in ('Customer') then 'Expansion'
                else null
            end as motion,
            o.lead_source_category_c,
            o.type as opp_type,
            a.name as account_name,
            null as matched_account_name_c,
            a.account_tier_c,
            null as deployment_status_c,
            null as type,
            convert_timezone('UTC', 'America/Los_Angeles', o._fivetran_synced::timestamp_ntz) as sync_date,
            o.cms_sales_motion_c,
            o.expansion_sales_motion_c,
            o.demand_bucket_c,
            case
                when month(stage_enter_mqo_c) in (2, 3, 4) then 1
                when month(stage_enter_mqo_c) in (5, 6, 7) then 2
                when month(stage_enter_mqo_c) in (8, 9, 10) then 3
                when month(stage_enter_mqo_c) in (11, 12, 1) then 4
            end as fiscal_quarter,
            case
                when month(stage_enter_mqo_c) >= 2 then year(stage_enter_mqo_c) + 1
                else year(stage_enter_mqo_c)
            end as fiscal_year
        from opportunity_base o
        left join account_base a on o.account_id = a.id
        left join conversion_rate d on o.currency_iso_code = d.iso_code
        where 1=1
            and (
                o.currency_iso_code = 'USD' or
                (
                    o.close_date between d.start_date and d.next_start_date - 1 and
                    d.conversion_rate is not null
                )
            )
            and o.record_type_c in ('CPQ Amendment', 'CPQ Sales')
            and o.type = 'New Business'
    )

    -- Final UNION ALL
    select * from mel_volume
    union all
    select * from mql_volume
    union all
    select * from sal_volume
    union all
    select * from sql_volume
    union all
    select * from mel_to_mql_conversion
    union all
    select * from mql_to_sal_conversion
    union all
    select * from sal_to_sql_conversion
    union all
    select * from cdp_pipeline
    union all
    select * from cms_pipeline
    union all
    select * from cdp_bookings
    union all
    select * from cms_bookings
    union all
    select * from closed_won_opps
    union all
    select * from avg_sales_cycle
    union all
    select * from closed_lost_reason
    union all
    select * from expansion_bookings
    union all
    select * from time_to_deploy
    union all
    select * from onboarded_within_target
    union all
    select * from renewals_with_expansion
    union all
    select * from asc_sales_motion_new_biz
    union all
    select * from asc_expansion_motion_existing_biz
    union all
    select * from mqo_volume
