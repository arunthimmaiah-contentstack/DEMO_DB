# Reference this view as staging__stg_salesforce__survey
#This description was pulled from dbt.
description: |
  Staging model for Salesforce survey responses related to cases. Includes survey ID, associated case ID, and CSAT score.

schema: STAGING
table_name: STG_SALESFORCE__SURVEY

dimensions:
  survey_id:
    sql: '"SURVEY_ID"'
    format: ID
    #This description was pulled from dbt.
    description: Primary key. Salesforce Survey Response ID.

  case_c:
    sql: '"CASE_C"'

  chat_transcript_c:
    sql: '"CHAT_TRANSCRIPT_C"'

  survey_type_c:
    sql: '"SURVEY_TYPE_C"'

  account_c:
    sql: '"ACCOUNT_C"'

  response_completed_c:
    sql: '"RESPONSE_COMPLETED_C"'

  account_name:
    sql: '"ACCOUNT_NAME"'

  case_csat_score:
    sql: '"CASE_CSAT_SCORE"'

  chat_csat_score:
    sql: '"CHAT_CSAT_SCORE"'

measures:
  count:
    aggregate_type: count

#The info below was pulled from your dbt repository and is read-only.
dbt:
  name: stg_salesforce__survey
  target_schema: STAGING
  description: |
    Staging model for Salesforce survey responses related to cases. Includes survey ID, associated case ID, and CSAT score.
  config:
    schema: staging
    materialized: view
  code: |-
    with source as (
        select *
        from {{ source('salesforce_case', 'CONTENTSTACK_SURVEY_RESPONSE_C') }}
        where is_deleted = false
          and response_completed_c is not null
    ),

    accounts as (
        select * from {{ ref('stg_salesforce__accounts') }}
    ),

    mapped as (
        select 
            csr.id as survey_id,
            csr.case_c,
            csr.chat_transcript_c,
            csr.survey_type_c,
            csr.account_c,
            csr.response_completed_c,
            a.account_name,
            case 
                when csr.csat_for_support_experience_c = 'Very Satisfied' then 5
                when csr.csat_for_support_experience_c = 'Satisfied' then 4
                when csr.csat_for_support_experience_c = 'Dissatisfied' then 2
                when csr.csat_for_support_experience_c = 'Very Dissatisfied' then 1
            end as case_csat_score,
            csr.rating_c as chat_csat_score
        from source csr
        left join accounts a
            on csr.account_c = a.account_id 
        where (a.account_id is null or a.account_name not like '%Contentstack%')
    )

    select * from mapped
  referenced_by: [ fct_cases ]
