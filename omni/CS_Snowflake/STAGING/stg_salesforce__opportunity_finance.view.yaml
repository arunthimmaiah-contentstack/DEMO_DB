# Reference this view as staging__stg_salesforce__opportunity_finance
schema: STAGING
table_name: STG_SALESFORCE__OPPORTUNITY_FINANCE

dimensions:
  id:
    sql: '"ID"'
    format: ID
    primary_key: true

  opportunity_id:
    sql: '"OPPORTUNITY_ID"'
    format: ID

  product:
    sql: '"PRODUCT"'

  customer_designation:
    sql: '"CUSTOMER_DESIGNATION"'

  product_pipeline_deal_percentage:
    sql: '"PRODUCT_PIPELINE_DEAL_PERCENTAGE"'

  product_deal_percentage:
    sql: '"PRODUCT_DEAL_PERCENTAGE"'

  currency_iso_code:
    sql: '"CURRENCY_ISO_CODE"'

  total_original_piped_amount:
    sql: '"TOTAL_ORIGINAL_PIPED_AMOUNT"'

  converted_total_original_piped_amount:
    sql: '"CONVERTED_TOTAL_ORIGINAL_PIPED_AMOUNT"'

  opp_total_bookings:
    sql: '"OPP_TOTAL_BOOKINGS"'

  converted_opp_total_bookings:
    sql: '"CONVERTED_OPP_TOTAL_BOOKINGS"'

measures:
  count:
    aggregate_type: count

#The info below was pulled from your dbt repository and is read-only.
dbt:
  name: stg_salesforce__opportunity_finance
  target_schema: STAGING
  config:
    schema: staging
    materialized: view
  code: |-
    select
        concat(o.id,'|',o.name) as id,
        o.id as opportunity_id,
        'Lytics' as product,
        'CDP' as customer_designation, --CDP product calculation
        cdp_pipeline_percentage_c as product_pipeline_deal_percentage, --this is for new pipeline calculations
        cdp_deal_percentage_c as product_deal_percentage, --this is for bookings calculations
        currency_iso_code,
        total_original_piped_amount_c as total_original_piped_amount,
        (total_original_piped_amount_c * (1 / d.conversion_rate)) * (product_pipeline_deal_percentage / 100) as converted_total_original_piped_amount,
        opp_total_bookings_c as opp_total_bookings,
        (opp_total_bookings_c * (1 / d.conversion_rate)) * (product_deal_percentage / 100) as converted_opp_total_bookings
    from fivetran_database.salesforce.opportunity o
    LEFT JOIN
        fivetran_database.salesforce.dated_conversion_rate d ON o.currency_iso_code = d.iso_code
    WHERE
        1=1
        AND (
            o.currency_iso_code = 'USD' OR
            (
                o.close_date BETWEEN d.start_date AND d.next_start_date-1 AND
                d.conversion_rate IS NOT NULL
            )
        )
        AND O.IS_DELETED != 'TRUE'
        --and o.id = '006Uc00000LB4k9IAD'

    UNION All 

    select
        concat(o.id,'|',o.name) as id,
        o.id as opportunity_id,
        'CS' as product,
        'CMS' as customer_designation, --CMS product calculation
        case
            when CDP_PIPELINE_PERCENTAGE_C is Null then 100
            else (100 - CDP_PIPELINE_PERCENTAGE_C) 
        end as product_pipeline_deal_percentage,
        case
            when cdp_deal_percentage_c is Null then 100
            else (100 - cdp_deal_percentage_c) 
        end as product_deal_percentage,
        currency_iso_code,
        total_original_piped_amount_c as total_original_piped_amount,
        (total_original_piped_amount_c * (1 / d.conversion_rate)) * (product_pipeline_deal_percentage / 100) as converted_total_original_piped_amount,
        opp_total_bookings_c as opp_total_bookings,
        (opp_total_bookings_c * (1 / d.conversion_rate)) * (product_deal_percentage / 100) as converted_opp_total_bookings
    from fivetran_database.salesforce.opportunity o
    LEFT JOIN
        fivetran_database.salesforce.dated_conversion_rate d ON o.currency_iso_code = d.iso_code
    WHERE
        1=1
        AND (
            o.currency_iso_code = 'USD' OR
            (
                o.close_date BETWEEN d.start_date AND d.next_start_date-1 AND
                d.conversion_rate IS NOT NULL
            )
        )
        AND O.IS_DELETED != 'TRUE'
  referenced_by: [ new_pipeline, int_salesforce__opportunity_unified ]
