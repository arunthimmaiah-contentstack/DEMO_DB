# Reference this view as marts__fct_opportunities
label: Sales Performance

schema: MARTS
table_name: FCT_OPPORTUNITIES

dimensions:
  opportunity_id:
    sql: '"OPPORTUNITY_ID"'
    format: ID
    primary_key: true

  account_id:
    sql: '"ACCOUNT_ID"'
    format: ID

  opportunity_name:
    sql: '"OPPORTUNITY_NAME"'

  stage_name:
    sql: '"STAGE_NAME"'

  opp_total_bookings:
    sql: '"OPP_TOTAL_BOOKINGS"'

  closed_won_bookings:
    sql: '"CLOSED_WON_BOOKINGS"'

  closed_lost_bookings:
    sql: '"CLOSED_LOST_BOOKINGS"'

  closed_won_count:
    sql: '"CLOSED_WON_COUNT"'

  closed_lost_count:
    sql: '"CLOSED_LOST_COUNT"'

  is_won:
    sql: '"IS_WON"'

  is_closed:
    sql: '"IS_CLOSED"'

  days_in_pipeline:
    sql: '"DAYS_IN_PIPELINE"'

  created_date:
    sql: '"CREATED_DATE"'

  close_date:
    sql: '"CLOSE_DATE"'

  type:
    sql: '"TYPE"'

  record_type_c:
    sql: '"RECORD_TYPE_C"'

  account_type_c:
    sql: '"ACCOUNT_TYPE_C"'

  fiscal_quarter:
    sql: '"FISCAL_QUARTER"'

  pipeline_date_c:
    sql: '"PIPELINE_DATE_C"'

  owner_id:
    sql: '"OWNER_ID"'
    format: ID

  _entity_opportunity:
    # Entity is defined in the 'sales_performance' dbt semantic model (models/semantic_models/sem_sales_performance.yml)
    sql: ${opportunity_id}
    hidden: true

  _entity_account:
    # Entity is defined in the 'sales_performance' dbt semantic model (models/semantic_models/sem_sales_performance.yml)
    sql: ${account_id}
    hidden: true

  _entity_owner:
    # Entity is defined in the 'sales_performance' dbt semantic model (models/semantic_models/sem_sales_performance.yml)
    sql: ${owner_id}
    hidden: true

measures:
  count:
    aggregate_type: count

  days_in_pipeline:
    # Measure is defined in the 'sales_performance' dbt semantic model (models/semantic_models/sem_sales_performance.yml)
    sql: ${days_in_pipeline}
    description: Average days in pipeline
    aggregate_type: average

#The info below was pulled from your dbt repository and is read-only.
dbt:
  name: fct_opportunities
  target_schema: STAGING
  config:
    schema: marts
    materialized: table
    tags: [ sales, fact ]
  code: |-
    {{ config(
        materialized = "table",
        tags = ["sales", "fact"]
    ) }}

    select
        id as opportunity_id,
        account_id,
        name as opportunity_name,
        stage_name,
        amount as opp_total_bookings,
        case when stage_name = 'Closed Won' then amount else 0 end as closed_won_bookings,
        case when stage_name = 'Closed Lost' then amount else 0 end as closed_lost_bookings,
        case when stage_name = 'Closed Won' then 1 else 0 end as closed_won_count,
        case when stage_name = 'Closed Lost' then 1 else 0 end as closed_lost_count,
        is_won,
        is_closed,
        -- add pipeline days calculation here
        datediff('day', created_date, close_date) as days_in_pipeline,
        -- add columns for stage progression measures
        created_date,
        close_date,
        type,
        record_type_c,
        account_type_c,
        fiscal_quarter,
        pipeline_date_c,
        owner_id
    from {{ source('salesforce_opportunity', 'opportunity') }}
  referenced_by: [ fct_quota_attainment ]
