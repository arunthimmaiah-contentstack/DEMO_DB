# Reference this view as marts__dbt_query_refactoring
#This description was pulled from dbt.
description: Fact table for org API usage

schema: MARTS
table_name: DBT_QUERY_REFACTORING

dimensions:
  date:
    sql: '"DATE"'

  organization_uid:
    sql: '"ORGANIZATION_UID"'
    #This description was pulled from dbt.
    description: Uid unique id for the tables

  name:
    sql: '"NAME"'

  location:
    sql: '"LOCATION"'

  platform:
    sql: '"PLATFORM"'

  tags:
    sql: '"TAGS"'

  all_requests:
    sql: '"ALL_REQUESTS"'

  cdn_bandwidth:
    sql: '"CDN_BANDWIDTH"'

  cdn_count:
    sql: '"CDN_COUNT"'

  assets_bandwidth:
    sql: '"ASSETS_BANDWIDTH"'

  assets_count:
    sql: '"ASSETS_COUNT"'

  images_bandwidth:
    sql: '"IMAGES_BANDWIDTH"'

  images_count:
    sql: '"IMAGES_COUNT"'

  api_bandwidth:
    sql: '"API_BANDWIDTH"'

  api_count:
    sql: '"API_COUNT"'

  ui_bandwidth:
    sql: '"UI_BANDWIDTH"'

  ui_count:
    sql: '"UI_COUNT"'

  graphql_bandwidth:
    sql: '"GRAPHQL_BANDWIDTH"'

  graphql_count:
    sql: '"GRAPHQL_COUNT"'

  cma_bandwidth:
    sql: '"CMA_BANDWIDTH"'

  cma_count:
    sql: '"CMA_COUNT"'

  stacks:
    sql: '"STACKS"'

  entries:
    sql: '"ENTRIES"'

  assets:
    sql: '"ASSETS"'

  content_types:
    sql: '"CONTENT_TYPES"'

  environments:
    sql: '"ENVIRONMENTS"'

  locales:
    sql: '"LOCALES"'

  users:
    sql: '"USERS"'

  extensions:
    sql: '"EXTENSIONS"'

  roles:
    sql: '"ROLES"'

  global_fields:
    sql: '"GLOBAL_FIELDS"'

measures:
  count:
    aggregate_type: count

#The info below was pulled from your dbt repository and is read-only.
dbt:
  name: dbt_query_refactoring
  target_schema: STAGING
  description: Fact table for org API usage
  config:
    schema: marts
    materialized: table
  code: |-
    with org_stats as (
            select date_trunc('month', a.date) as Date
                , a.uid Organization_uid
                , a.name
                , a.location
                , a.platform
                , orgs.tags tags
                , md.cdn_count + md.assets_count + md.images_count + md.graphql_count + md.cma_count as All_requests
                , md.cdn_bandwidth
                , md.cdn_count
                , md.assets_bandwidth
                , md.assets_count
                , md.images_bandwidth
                , md.images_count
                , md.api_bandwidth
                , md.api_count
                , md.ui_bandwidth
                , md.ui_count
                , md.graphql_bandwidth
                , md.graphql_count
                , md.cma_bandwidth
                , md.cma_count
                , stacks
                , entries
                , assets
                , content_types
                , environments
                , locales
                , users
                , extensions
                , roles
                , global_fields
            from {{ref('stg_analytics__fact_org_db_usage_actuals')}} a 
            join (select date_trunc('month', date) month
                    , A.uid 
                    , A.location
                    , A.platform
                    , max(date) max_date
                    , sum(cdn_bandwidth) cdn_bandwidth
                    , sum(cdn_count) cdn_count
                    , sum(assets_bandwidth) assets_bandwidth
                    , sum(ASSETS_COUNT) ASSETS_COUNT
                    , sum(images_bandwidth) images_bandwidth
                    , sum(IMAGES_COUNT) IMAGES_COUNT
                    , sum(api_bandwidth) api_bandwidth
                    , sum(api_count) api_count
                    , sum(ui_bandwidth) ui_bandwidth
                    , sum(ui_count) ui_count
                    , sum(graphql_bandwidth) graphql_bandwidth
                    , sum(graphql_count) graphql_count
                    , sum(cma_bandwidth) cma_bandwidth
                    , sum(cma_count) cma_count
                  from (select db.*,
                        cdn_bandwidth,
                        cdn_count,
                        assets_bandwidth,
                        ASSETS_COUNT,
                        images_bandwidth,
                        IMAGES_COUNT,
                        api_bandwidth,
                        api_count,
                        ui_bandwidth,
                        ui_count,
                        graphql_bandwidth,
                        graphql_count,
                        cma_bandwidth,
                        cma_count
                        from {{ ref('stg_analytics__fact_org_db_usage_actuals') }} db
                        LEFT join {{ ref('stg_analytics__fact_org_api_usage_actuals') }} api
                          on api.uid = db.uid
                          and api.Date = db.Date
                          and api.Location = db.Location) A
                    group by date_trunc('month', date)
                    , A.uid 
                    , A.location
                    , A.platform) md
                on md.max_date = a.date and md.uid = a.uid and md.location = a.location and md.platform = a.platform
            join (select uid,
                        name,
                        tags,
                        location,
                        platform
                  from {{ ref('stg_analytics__sa_all_organizations_a') }}) orgs
            on a.uid = orgs.uid and a.location = orgs.location and a.platform = orgs.platform
            where 1=1
                and a.date between '2025-07-01' and current_date()
                and orgs.tags = 'customer'
        )
        
    select * from org_stats
