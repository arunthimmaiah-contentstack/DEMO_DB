# Reference this view as marts__win_rate
schema: MARTS
table_name: WIN_RATE

dimensions:
  opportunity_close_date:
    sql: '"OPPORTUNITY_CLOSE_DATE"'

  win_rate:
    sql: '"WIN_RATE"'

measures:
  count:
    aggregate_type: count

#The info below was pulled from your dbt repository and is read-only.
dbt:
  name: win_rate
  target_schema: STAGING
  config:
    schema: marts
    materialized: table
  code: |-
    with opportunity_metrics as (
        select
        opportunity_close_date,
            count(*) as opportunity_count,
            count(case when is_won = true then 1 end) as won_opportunity_count
        from _omni_ref_sub_
        group by opportunity_close_date
    )

    select
        opportunity_close_date,
        case 
            when opportunity_count = 0 then null
            else won_opportunity_count * 1.0 / opportunity_count
        end as win_rate
    from opportunity_metrics
